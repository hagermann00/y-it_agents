graph TD
    %% Global Styles
    classDef layer fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef process fill:#fff9c4,stroke:#fbc02d,stroke-width:1px;
    classDef decision fill:#f8bbd0,stroke:#880e4f,stroke-width:2px;
    classDef artifact fill:#e8f5e9,stroke:#2e7d32,stroke-width:1px,stroke-dasharray: 5 5;

    %% INPUT
    RawSources[("Raw Sources (500+)")]:::artifact
    Manifest["Source Manifest (Sheets)"]:::artifact
    SOP["Research SOP.pdf"]:::artifact

    %% PHASE 1: TRIAGE
    subgraph Phase1 ["PHASE 1: TRIAGE & PREPARATION"]
        direction TB
        FilterSources[Filter to ~300 Golden Sources]:::process
        AssignBatches[Assign to Batches (25-40/batch)]:::process
    end

    RawSources --> FilterSources
    Manifest --> FilterSources
    FilterSources --> AssignBatches
    SOP --> |"Anchor Source #1"| NB_Setup

    %% PHASE 2: BATCH
    subgraph Phase2 ["LAYER 1: BATCH (Gemini)"]
        direction TB
        NB_Setup[Create Worker Notebooks]:::process
        UploadSources[Upload Sources #2-41]:::process
        NB_Ready[("Ready Notebooks")]:::artifact
    end

    AssignBatches --> NB_Setup
    NB_Setup --> UploadSources
    UploadSources --> NB_Ready

    %% PHASE 3: EXTRACT
    subgraph Phase3 ["LAYER 2: EXTRACT (Perplexity)"]
        direction TB
        GoldenPrompt["Run 'Golden Prompt'"]:::process
        ParseJSON[Parse & Validate JSON]:::process
        RawJSON[("Raw Extraction JSON")]:::artifact
    end

    NB_Ready --> GoldenPrompt
    GoldenPrompt --> ParseJSON
    ParseJSON --> RawJSON

    %% PHASE 4: VERIFY
    subgraph Phase4 ["LAYER 3: VERIFY (Grok)"]
        direction TB
        ExtractorLLM[Extractor LLM]:::process
        CriticLLM["Critic LLM (Adversarial)"]:::process
        HallucinationCheck{Hallucination Check}:::decision
        HHEM[HHEM / LettuceDetect]:::process
        FlagIssues[Flag Issues]:::process
        VerifiedJSON[("Verified JSON")]:::artifact
    end

    RawJSON --> ExtractorLLM
    ExtractorLLM --> CriticLLM
    CriticLLM --> HallucinationCheck
    HallucinationCheck -->|Pass| VerifiedJSON
    HallucinationCheck -->|Fail| FlagIssues
    FlagIssues --> ExtractorLLM
    HHEM -.-> HallucinationCheck

    %% PHASE 5: SCORE
    subgraph Phase5 ["LAYER 4: SCORE (ChatGPT)"]
        direction TB
        CalcRep["Calc Reputation (50pts)"]:::process
        CalcContent["Calc Content (30pts)"]:::process
        CalcConf["Calc Confidence (10pts)"]:::process
        CalcAgree["Calc Consensus (10pts)"]:::process
        TotalScore{Total Score}:::decision
    end

    VerifiedJSON --> CalcRep
    CalcRep --> CalcContent
    CalcContent --> CalcConf
    CalcConf --> CalcAgree
    CalcAgree --> TotalScore

    %% PHASE 6: RESOLVE
    subgraph Phase6 ["LAYER 5: RESOLVE (Grok)"]
        direction TB
        DetectConflict{Conflict Detected?}:::decision
        MultiAgentDebate[Multi-Agent Debate]:::process
        Advocate["Agent: Advocate"]:::process
        Devil["Agent: Devil's Advocate"]:::process
        Consensus{Consensus Reached?}:::decision
        FinalMaster[("FINAL MASTER TABLE")]:::artifact
        HumanReview[Human Review Required]:::process
    end

    TotalScore --> DetectConflict
    DetectConflict -->|No| FinalMaster
    DetectConflict -->|Yes| MultiAgentDebate
    MultiAgentDebate --> Advocate
    MultiAgentDebate --> Devil
    Advocate --> Consensus
    Devil --> Consensus
    Consensus -->|Yes| FinalMaster
    Consensus -->|No| HumanReview

    %% Styling
    class Phase1,Phase2,Phase3,Phase4,Phase5,Phase6 layer;
